# ==================================================================
# Profile Queries
# ==================================================================

# Get current user's profile with subscription data
query GetUserProfile($userId: UUID!) {
  profilesCollection(filter: { id: { eq: $userId } }, first: 1) {
    edges {
      node {
        id
        email
        full_name
        username
        avatar_url

        # Basic Info
        age
        gender

        # Physical Measurements
        height_cm
        weight_kg
        target_weight_kg

        # Preferences
        unit_system
        occupation_activity

        # Onboarding
        onboarding_completed
        onboarding_step

        # Timestamps
        created_at
        updated_at

        # Subscription data
        subscriptions {
          id
          tier
          status
          stripe_customer_id
          stripe_subscription_id
          current_period_start
          current_period_end
          trial_end
          cancel_at_period_end
        }
      }
    }
  }
}

# Get user profile (simple version without subscription)
query GetProfile($userId: UUID!) {
  profilesCollection(filter: { id: { eq: $userId } }, first: 1) {
    edges {
      node {
        id
        email
        full_name
        username
        avatar_url
        age
        gender
        height_cm
        weight_kg
        target_weight_kg
        unit_system
        occupation_activity
        onboarding_completed
        onboarding_step
        created_at
        updated_at
      }
    }
  }
}

# Get user subscription
query GetUserSubscription($userId: UUID!) {
  subscriptionsCollection(filter: { user_id: { eq: $userId } }, first: 1) {
    edges {
      node {
        id
        user_id
        tier
        status
        stripe_customer_id
        stripe_subscription_id
        stripe_price_id
        current_period_start
        current_period_end
        trial_start
        trial_end
        cancel_at_period_end
        canceled_at
        metadata
        created_at
        updated_at
      }
    }
  }
}

# ==================================================================
# Profile Mutations
# ==================================================================

# Update user profile
mutation UpdateUserProfile(
  $userId: UUID!
  $fullName: String
  $username: String
  $avatarUrl: String
  $age: Int
  $dateOfBirth: Date
  $gender: String
  $country: String
  $heightCm: Float
  $weightKg: Float
  $targetWeightKg: Float
  $unitSystem: String
  $occupationActivity: String
  $onboardingCompleted: Boolean
  $onboardingStep: Int
) {
  updateprofilesCollection(
    filter: { id: { eq: $userId } }
    set: {
      full_name: $fullName
      username: $username
      avatar_url: $avatarUrl
      age: $age
      gender: $gender
      height_cm: $heightCm
      weight_kg: $weightKg
      target_weight_kg: $targetWeightKg
      unit_system: $unitSystem
      occupation_activity: $occupationActivity
      onboarding_completed: $onboardingCompleted
      onboarding_step: $onboardingStep
    }
  ) {
    records {
      id
      email
      full_name
      username
      avatar_url
      age
      gender
      height_cm
      weight_kg
      target_weight_kg
      unit_system
      occupation_activity
      onboarding_completed
      onboarding_step
      updated_at
    }
    affectedCount
  }
}

# Create user profile (for onboarding)
mutation CreateUserProfile(
  $id: UUID!
  $email: String!
  $fullName: String
  $age: Int
  $gender: String
  $heightCm: Float
  $weightKg: Float
  $targetWeightKg: Float
) {
  insertIntoprofilesCollection(
    objects: [
      {
        id: $id
        email: $email
        full_name: $fullName
        age: $age
        gender: $gender
        height_cm: $heightCm
        weight_kg: $weightKg
        target_weight_kg: $targetWeightKg
        onboarding_completed: false
        onboarding_step: 0
      }
    ]
  ) {
    records {
      id
      email
      full_name
      age
      gender
      height_cm
      weight_kg
      target_weight_kg
      onboarding_completed
      onboarding_step
      created_at
    }
    affectedCount
  }
}

# Update avatar URL (called after Supabase Storage upload)
mutation UpdateUserAvatar($userId: UUID!, $avatarUrl: String!) {
  updateprofilesCollection(
    filter: { id: { eq: $userId } }
    set: { avatar_url: $avatarUrl }
  ) {
    records {
      id
      avatar_url
      updated_at
    }
    affectedCount
  }
}

# Delete avatar (set to null after Storage deletion)
mutation DeleteUserAvatar($userId: UUID!) {
  updateprofilesCollection(
    filter: { id: { eq: $userId } }
    set: { avatar_url: null }
  ) {
    records {
      id
      avatar_url
      updated_at
    }
    affectedCount
  }
}
